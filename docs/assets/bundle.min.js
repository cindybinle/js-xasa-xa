function Tool(cxt,preCxt){this._cxt=cxt,this._preCxt=preCxt}function DrawingTool(cxt,preCxt){Tool.apply(this,arguments)}function ShapeTool(cxt,preCxt){DrawingTool.apply(this,arguments)}function PencilTool(cxt,preCxt){DrawingTool.apply(this,arguments),this._imageData=cxt.createImageData(1,1)}function DoodleTool(cxt,preCxt){DrawingTool.apply(this,arguments)}function LineTool(cxt,preCxt){DrawingTool.apply(this,arguments)}function CurveTool(cxt,preCxt){DrawingTool.apply(this,arguments),this._state=CurveTool.STATE_NOT_STARTED}function RectangleTool(cxt,preCxt){ShapeTool.apply(this,arguments)}function OvalTool(cxt,preCxt){ShapeTool.apply(this,arguments)}function EraserTool(cxt,preCxt){DrawingTool.apply(this,arguments)}function FloodFillTool(cxt,preCxt){Tool.apply(this,arguments)}function EyedropperTool(cxt,preCxt){Tool.apply(this,arguments)}function SelectionTool(cxt,preCxt){Tool.apply(this,arguments),this._outline=document.createElement("div"),this._outline.className="floatingRegion",this._outline.style.cursor="move"}function TextTool(cxt,preCxt){Tool.apply(this,arguments),this._textElem=document.createElement("p"),this._textElem.contentEditable=!0,this._textElem.className="floatingRegion",this._textElem.style.lineHeight="100%",this._textElem.style.WebkitTransformOrigin=this._textElem.style.MozTransformOrigin=this._textElem.style.MsTransformOrigin=this._textElem.style.OTransformOrigin=this._textElem.style.transformOrigin="0 0",this._textElem.style.padding=TextTool.PADDING+"px",this._textElem.onblur=this._removeTextElem.bind(this)}function PanTool(cxt,preCxt){Tool.apply(this,arguments)}function PacMan(canvas,x,y){this._started=!1,this._canvas=canvas,this._cxt=canvas.getContext("2d"),this.x=x||Math.floor(.2*canvas.width),this.y=y||Math.floor(.2*canvas.height),this.heading=PacMan.HEADINGS.RIGHT,this._startSound=document.getElementById("pacManStartSound"),this._mouthSize=0,this._mouthOpening=!0,this._boundUpdate=this._update.bind(this),this._initListeners()}function switchTool(tool){tools[localStorage.tool].deactivate(),Utils.clearCanvas(preCxt),localStorage.tool=tool,tools[tool].activate(),document.getElementById("tools").tool.value=tool}function initToolbar(){function limitValue(value,min,max){return value<min?min:value>max?max:value}function updateColorPickerHex(e){var type=e.target.name.match(/line|fill/)[0],hex=colorPickerDialog[type+"ColorHex"].value;hex.match(/#[0-9A-Fa-f]{6}/)&&colorPickers[type].setHex(hex)}function updateColorPickerHSL(e){var type=e.target.name.match(/line|fill/)[0],h=colorPickerDialog[type+"ColorHue"].value||0;h=limitValue(h,0,360);var s=(colorPickerDialog[type+"ColorSaturation"].value||0)/100;s=limitValue(s,0,100);var l=(colorPickerDialog[type+"ColorLightness"].value||0)/100;l=limitValue(l,0,100),colorPickers[type].setHsv({h:h,s:s,v:l})}function updateColorPickerRGB(e){var type=e.target.name.match(/line|fill/)[0],r=colorPickerDialog[type+"ColorRed"].value||0;r=limitValue(r,0,255);var g=colorPickerDialog[type+"ColorGreen"].value||0;g=limitValue(g,0,255);var b=colorPickerDialog[type+"ColorBlue"].value||0;b=limitValue(b,0,255),colorPickers[type].setRgb({r:r,g:g,b:b})}function updateColorFields(type,pickerCoords,hex,hsv,rgb){if(hsv.h=limitValue(hsv.h,0,360),hsv.s=limitValue(hsv.s,0,100),hsv.v=limitValue(hsv.v,0,100),rgb.r=limitValue(rgb.r,0,255),rgb.g=limitValue(rgb.g,0,255),rgb.b=limitValue(rgb.b,0,255),hex=ColorPicker.rgb2hex(rgb),pickerCoords){var pickerIndicator=colorPickers[type].pickerElement.getElementsByClassName("picker-indicator")[0];pickerIndicator.style.left=100*hsv.s+"%",pickerIndicator.style.top=100-100*hsv.v+"%"}var sliderIndicator=colorPickers[type].slideElement.getElementsByClassName("slide-indicator")[0];sliderIndicator.style.top=hsv.h/360*100+"%",document.getElementById(type+"ColorSample").style.backgroundColor=hex,colorPickerDialog[type+"ColorHex"].value=hex,colorPickerDialog[type+"ColorHue"].value=Math.floor(hsv.h),colorPickerDialog[type+"ColorSaturation"].value=Math.floor(100*hsv.s),colorPickerDialog[type+"ColorLightness"].value=Math.floor(100*hsv.v),colorPickerDialog[type+"ColorRed"].value=rgb.r,colorPickerDialog[type+"ColorGreen"].value=rgb.g,colorPickerDialog[type+"ColorBlue"].value=rgb.b}for(var forms=document.getElementsByTagName("form"),i=0;i<forms.length;i++)forms[i].addEventListener("submit",function(e){e.preventDefault()},!1);document.getElementById("tools").onchange=function(e){switchTool(e.target.value)},document.getElementById("lineWidth").onchange=function(e){localStorage.lineWidth=e.target.value,tools[localStorage.tool].activate()},document.getElementById("outlineOptions").onchange=function(e){localStorage.outlineOption=e.target.value};for(var colorPicker=document.getElementById("colorPicker"),colorIndicator=document.getElementById("colors"),colors=colorPicker.getElementsByTagName("button"),i=0;i<colors.length;i++)colors[i].addEventListener("click",function(e){e.altKey||e.ctrlKey||e.shiftKey||(e.preventDefault(),e.stopPropagation(),0===e.button&&(localStorage.lineColor=e.target.dataset.value,colorIndicator.style.borderColor=e.target.dataset.value,tools[localStorage.tool].activate()))},!1),colors[i].addEventListener("contextmenu",function(e){e.preventDefault(),e.stopPropagation(),2===e.button&&(localStorage.fillColor=e.target.dataset.value,colorIndicator.style.backgroundColor=e.target.dataset.value,tools[localStorage.tool].activate())},!1);var colorPickerDialog=document.getElementById("colorPickerDialog");Utils.makeDialog(colorPickerDialog);var colorPickers={line:new ColorPicker(document.getElementById("lineColorSlider"),document.getElementById("lineColorPicker"),function(hex,hsv,rgb,pickerCoords){updateColorFields("line",pickerCoords,hex,hsv,rgb)}),fill:new ColorPicker(document.getElementById("fillColorSlider"),document.getElementById("fillColorPicker"),function(hex,hsv,rgb,pickerCoords){updateColorFields("fill",pickerCoords,hex,hsv,rgb)})};colorPickerDialog.onsubmit=function(e){e.preventDefault(),""!==e.target.lineColorHex.value&&(localStorage.lineColor=e.target.lineColorHex.value,colorIndicator.style.borderColor=e.target.lineColorHex.value),""!==e.target.fillColorHex.value&&(localStorage.fillColor=e.target.fillColorHex.value,colorIndicator.style.backgroundColor=e.target.fillColorHex.value),e.target.close()},colorPickerDialog.lineColorHex.oninput=colorPickerDialog.fillColorHex.oninput=updateColorPickerHex,colorPickerDialog.lineColorHue.oninput=colorPickerDialog.lineColorSaturation.oninput=colorPickerDialog.lineColorLightness.oninput=colorPickerDialog.fillColorHue.oninput=colorPickerDialog.fillColorSaturation.oninput=colorPickerDialog.fillColorLightness.oninput=updateColorPickerHSL,colorPickerDialog.lineColorRed.oninput=colorPickerDialog.lineColorGreen.oninput=colorPickerDialog.lineColorBlue.oninput=colorPickerDialog.fillColorRed.oninput=colorPickerDialog.fillColorGreen.oninput=colorPickerDialog.fillColorBlue.oninput=updateColorPickerRGB,colorIndicator.onclick=function(){colorPickers.line.setHex(localStorage.lineColor),colorPickerDialog.lineColorHex.value=localStorage.lineColor,colorPickers.fill.setHex(localStorage.fillColor),colorPickerDialog.fillColorHex.value=localStorage.fillColor,colorPickerDialog.open()},document.querySelector('#colorPicker button[data-value="#FFEB3B"]').addEventListener("click",function(e){(!Utils.isApple&&e.ctrlKey||Utils.isApple&&e.metaKey)&&e.shiftKey&&(e.preventDefault(),e.stopPropagation(),window.pacMan?(window.pacMan.stop(),delete window.pacMan,e.target.classList.remove("pacman")):(window.pacMan=new PacMan(canvas),window.pacMan.start(),e.target.className="pacman"))},!1);var clearDialog=document.getElementById("clearDialog"),clearBtn=document.getElementById("clearBtn");Utils.makeDialog(clearDialog,clearBtn),clearDialog.onsubmit=function(e){function expandClearCircle(){radius+=STEP,cxt.fillStyle="#ffffff",cxt.beginPath(),cxt.arc(CENTER_X,CENTER_Y,radius,0,2*Math.PI),cxt.closePath(),cxt.fill(),radius<MAX_RADIUS?Utils.raf(expandClearCircle):undoStack.addState()}e.preventDefault();var CENTER_X=0,CENTER_Y=-224,MAX_RADIUS=2*Math.max(canvas.width,canvas.height),STEP=Math.floor(MAX_RADIUS/16),radius=224;Utils.raf(expandClearCircle),e.target.close()},clearBtn.onclick=clearDialog.open;var saveDialog=document.getElementById("saveDialog"),saveBtn=document.getElementById("saveBtn");Utils.makeDialog(saveDialog,saveBtn),saveDialog.fileName.onchange=saveDialog.fileType.onchange=saveDialog.fileType.oninput=function(){var newName=fixExtension(saveDialog.fileName.value,saveDialog.fileType.value);saveDialog.fileName.value=newName,downloadLink.download=newName,downloadLink.href=canvas.toDataURL(saveDialog.fileType.value),downloadLink.type=saveDialog.fileType.value},saveBtn.onclick=function(){downloadLink.href=canvas.toDataURL(downloadLink.type||"image/png"),saveDialog.open()},downloadLink.onclick=function(){document.title=downloadLink.download+" - (paint.thuanitdn.com)",saveDialog.close()},document.getElementById("undoBtn").onclick=undoStack.undo.bind(undoStack),document.getElementById("redoBtn").onclick=undoStack.redo.bind(undoStack);var resizeDialog=document.getElementById("resizeDialog"),resizeBtn=document.getElementById("resizeBtn");Utils.makeDialog(resizeDialog,resizeBtn),resizeDialog.onsubmit=function(e){e.preventDefault();var newWidth=parseInt(e.target.width.value),newHeight=parseInt(e.target.height.value),mode=e.target.resizeMode.value;return!newWidth||!newHeight||isNaN(newWidth)||isNaN(newHeight)||newWidth<1||newHeight<1?void alert("Please enter valid dimensions."):(preCxt.drawImage(canvas,0,0),canvas.width=newWidth,canvas.height=newHeight,resetCanvas(),"scale"===mode?cxt.drawImage(preCanvas,0,0,newWidth,newHeight):cxt.drawImage(preCanvas,0,0),preCanvas.width=newWidth,preCanvas.height=newHeight,localStorage.width=newWidth,localStorage.height=newHeight,undoStack.addState(),void e.target.close())},resizeBtn.onclick=function(){resizeDialog.width.value=localStorage.width,resizeDialog.height.value=localStorage.height,resizeDialog.open()},document.getElementById("upload").addEventListener("change",function(e){if(window.File&&window.FileReader&&window.FileList&&window.Blob){progressSpinner.open();var file=e.target.files[0];if(!file)return;if(!file.type.match("image.*"))return void alert("Paint Online can only open valid image files.");var reader=new FileReader;reader.onload=function(ev){var image=new Image;image.src=ev.target.result,canvas.width=image.width,canvas.height=image.height,preCanvas.width=image.width,preCanvas.height=image.height,localStorage.width=image.width,localStorage.height=image.height,cxt.fillStyle="white",cxt.fillRect(0,0,canvas.width,canvas.height),cxt.drawImage(image,0,0),undoStack.clear();var fileName=file.name;JPEG_REGEX.test(fileName)?document.getElementById("saveDialog").fileType.value=downloadLink.type="image/jpeg":(document.getElementById("saveDialog").fileType.value=downloadLink.type="image/png",fileName=fileName.replace(FILE_EXT_REGEX,".png")),document.getElementById("saveDialog").fileName.value=downloadLink.download=fileName,document.title=fileName+"- (paint.thuanitdn.com)",progressSpinner.close()},reader.readAsDataURL(file)}else alert("Please switch to a browser that supports the file APIs such as Google Chrome or Internet Explorer 11.")},!1),document.getElementById("openBtn").addEventListener("click",function(e){document.getElementById("upload").click()},!1),document.getElementById("fullScreenBtn").onclick=function(){canvas.requestFullscreen?canvas.requestFullscreen():canvas.webkitRequestFullscreen?canvas.webkitRequestFullscreen():canvas.mozRequestFullScreen?canvas.mozRequestFullScreen():canvas.msRequestFullscreen?canvas.msRequestFullscreen():alert("Sorry, your web browser does not support full screen mode.")};var settingsDialog=document.getElementById("settingsDialog"),settingsBtn=document.getElementById("settingsBtn");Utils.makeDialog(settingsDialog,settingsBtn),settingsDialog.onsubmit=function(e){e.preventDefault(),e.target.ghostDraw.checked?(localStorage.ghostDraw="true",preCanvas.classList.add("ghost")):(localStorage.ghostDraw="",preCanvas.classList.remove("ghost")),localStorage.antiAlias=e.target.antiAlias.checked?"true":"",isNaN(parseInt(e.target.maxUndoStackDepth.value))||(localStorage.maxUndoStackDepth=parseInt(e.target.maxUndoStackDepth.value)),e.target.close()},settingsBtn.onclick=function(){settingsDialog.ghostDraw.checked=localStorage.ghostDraw,settingsDialog.antiAlias.checked=localStorage.antiAlias,settingsDialog.maxUndoStackDepth.value=localStorage.maxUndoStackDepth,settingsDialog.open()};var helpDialog=document.getElementById("helpDialog"),helpBtn=document.getElementById("helpBtn");Utils.makeDialog(helpDialog,helpBtn),helpBtn.onclick=helpDialog.open;var aboutDialog=document.getElementById("aboutDialog"),aboutBtn=document.getElementById("aboutBtn");Utils.makeDialog(aboutDialog,aboutBtn),aboutBtn.onclick=aboutDialog.open;var welcomeDialog=document.getElementById("welcomeDialog");Utils.makeDialog(welcomeDialog,doodleTool)}function initCanvas(){canvas=document.getElementById("canvas"),cxt=canvas.getContext("2d"),preCanvas=document.getElementById("preCanvas"),preCxt=preCanvas.getContext("2d"),cursorCanvas=document.getElementById("cursorCanvas"),cursorCxt=cursorCanvas.getContext("2d"),cxt.lineCap="round",preCxt.lineCap="round",preCanvas.addEventListener("pointerdown",startTool,!1),preCanvas.oncontextmenu=function(e){e.preventDefault()}}function initSettings(){for(var setting in DEFAULTS)setting in localStorage||(localStorage[setting]=DEFAULTS[setting]);canvas.width=localStorage.width,canvas.height=localStorage.height,preCanvas.width=localStorage.width,preCanvas.height=localStorage.height,localStorage.ghostDraw&&preCanvas.classList.add("ghost"),document.getElementById("lineWidth").value=localStorage.lineWidth,document.getElementById("outlineOptions").outlineOption.value=localStorage.outlineOption,document.getElementById("colors").style.borderColor=localStorage.lineColor,document.getElementById("colors").style.backgroundColor="#ffffff",document.getElementById("tools").tool.value=localStorage.tool}function initTools(){tools={pencil:new PencilTool(cxt,preCxt),doodle:new DoodleTool(cxt,preCxt),line:new LineTool(cxt,preCxt),curve:new CurveTool(cxt,preCxt),rect:new RectangleTool(cxt,preCxt),oval:new OvalTool(cxt,preCxt),eraser:new EraserTool(cxt,preCxt),floodFill:new FloodFillTool(cxt,preCxt),eyedropper:new EyedropperTool(cxt,preCxt),selection:new SelectionTool(cxt,preCxt),text:new TextTool(cxt,preCxt),pan:new PanTool(cxt,preCxt)},tools[localStorage.tool].activate()}function startTool(e){0!==e.button&&2!==e.button||(e.preventDefault(),e.stopPropagation(),preCanvas.removeEventListener("pointerdown",startTool,!1),canvas.focus(),tools[localStorage.tool].start({button:e.button,x:Utils.getCanvasX(e.pageX)/zoomManager.level,y:Utils.getCanvasY(e.pageY)/zoomManager.level}),document.addEventListener("pointermove",moveTool,!1),document.addEventListener("pointerup",endTool,!1),document.addEventListener("pointerleave",endTool,!1))}function moveTool(e){e.preventDefault(),e.stopPropagation(),tools[localStorage.tool].move({x:Utils.getCanvasX(e.pageX)/zoomManager.level,y:Utils.getCanvasY(e.pageY)/zoomManager.level})}function endTool(e){e.preventDefault(),e.stopPropagation(),document.removeEventListener("pointermove",moveTool,!1),document.removeEventListener("pointerup",endTool,!1),document.removeEventListener("pointerleave",endTool,!1),tools[localStorage.tool].end({x:Utils.getCanvasX(e.pageX)/zoomManager.level,y:Utils.getCanvasY(e.pageY)/zoomManager.level}),preCanvas.addEventListener("pointerdown",startTool,!1)}function resetCanvas(){cxt.fillStyle="#ffffff",cxt.fillRect(0,0,canvas.width,canvas.height)}function fixExtension(name,type){return name=name.trim(),"image/png"!==type||PNG_REGEX.test(name)?"image/jpeg"!==type||JPEG_REGEX.test(name)?name:FILE_EXT_REGEX.test(name)?name.replace(FILE_EXT_REGEX,".jpg"):name+".jpg":FILE_EXT_REGEX.test(name)?name.replace(FILE_EXT_REGEX,".png"):name+".png"}window.addEventListener("load",function(e){function makeActive(e){e.srcElement.classList?e.srcElement.classList.add("active"):e.srcElement.className+=" active"}function makeInactive(e){e.srcElement.classList?e.srcElement.classList.remove("active"):e.srcElement.className=e.srcElement.className.replace(/\s*active/g,"")}var inputElems=Array.prototype.slice.call(document.getElementsByTagName("button")).concat(Array.prototype.slice.call(document.getElementsByTagName("select"))).concat(Array.prototype.slice.call(document.getElementsByTagName("input")));document.querySelectorAll&&(inputElems=inputElems.concat(Array.prototype.slice.call(document.querySelectorAll('*[role="button"]'))));for(var elemTypes=["button","select"],inputTypes=["button","checkbox","radio","range","reset","submit"],i=0;i<inputElems.length;i++)(elemTypes.indexOf(inputElems[i].tagName.toLowerCase())!==-1||inputElems[i].type&&inputTypes.indexOf(inputElems[i].type.toLowerCase())!==-1||inputElems[i].getAttribute("role")&&"button"===inputElems[i].getAttribute("role").toLowerCase())&&(inputElems[i].addEventListener("touchstart",makeActive,!1),inputElems[i].addEventListener("touchend",makeInactive,!1),inputElems[i].addEventListener("touchcancel",makeInactive,!1))},!1),function(s,t,u){function mousePosition(a){if(s.event&&s.event.contentOverflow!==u)return{x:s.event.offsetX,y:s.event.offsetY};if(a.offsetX!==u&&a.offsetY!==u)return{x:a.offsetX,y:a.offsetY};var b=a.target.parentNode.parentNode;return{x:a.layerX-b.offsetLeft,y:a.layerY-b.offsetTop}}function $(a,b,c){a=t.createElementNS(svgNS,a);for(var d in b)a.setAttribute(d,b[d]);"[object Array]"!=Object.prototype.toString.call(c)&&(c=[c]);for(var i=0,len=c[0]&&c.length||0;i<len;i++)a.appendChild(c[i]);return a}function hsv2rgb(a){var R,G,B,X,C,h=a.h%360/60;C=a.v*a.s,X=C*(1-Math.abs(h%2-1)),R=G=B=a.v-C,h=~~h,R+=[C,X,0,0,X,C][h],G+=[X,C,C,X,0,0][h],B+=[0,0,X,C,C,X][h];var r=Math.floor(255*R),g=Math.floor(255*G),b=Math.floor(255*B);return{r:r,g:g,b:b,hex:"#"+(16777216|b|g<<8|r<<16).toString(16).slice(1)}}function rgb2hsv(a){var r=a.r,g=a.g,b=a.b;(a.r>1||a.g>1||a.b>1)&&(r/=255,g/=255,b/=255);var H,S,V,C;return V=Math.max(r,g,b),C=V-Math.min(r,g,b),H=0==C?null:V==r?(g-b)/C+(g<b?6:0):V==g?(b-r)/C+2:(r-g)/C+4,H=H%6*60,S=0==C?0:C/V,{h:H,s:S,v:V}}function slideListener(d,e,f){return function(a){a=a||s.event;var b=mousePosition(a);d.h=b.y/e.offsetHeight*360+hueOffset,d.s=d.v=1;var c=hsv2rgb({h:d.h,s:1,v:1});f.style.backgroundColor=c.hex,d.callback&&d.callback(c.hex,{h:d.h-hueOffset,s:d.s,v:d.v},{r:c.r,g:c.g,b:c.b},u,b)}}function pickerListener(d,e){return function(a){a=a||s.event;var b=mousePosition(a),width=e.offsetWidth,height=e.offsetHeight;d.s=b.x/width,d.v=(height-b.y)/height;var c=hsv2rgb(d);d.callback&&d.callback(c.hex,{h:d.h-hueOffset,s:d.s,v:d.v},{r:c.r,g:c.g,b:c.b},b)}}function ColorPicker(f,g,h){if(!(this instanceof ColorPicker))return new ColorPicker(f,g,h);if(this.h=0,this.s=1,this.v=1,h)this.callback=h,this.pickerElement=g,this.slideElement=f;else{var i=f;i.innerHTML=w,this.slideElement=i.getElementsByClassName("slide")[0],this.pickerElement=i.getElementsByClassName("picker")[0];var j=i.getElementsByClassName("slide-indicator")[0],k=i.getElementsByClassName("picker-indicator")[0];ColorPicker.fixIndicators(j,k),this.callback=function(a,b,c,d,e){ColorPicker.positionIndicators(j,k,e,d),g(a,b,c)}}if("SVG"==v){var l=slide.cloneNode(!0),m=picker.cloneNode(!0),n=l.getElementById("gradient-hsv"),o=l.getElementsByTagName("rect")[0];n.id="gradient-hsv-"+x,o.setAttribute("fill","url(#"+n.id+")");var p=[m.getElementById("gradient-black"),m.getElementById("gradient-white")],q=m.getElementsByTagName("rect");p[0].id="gradient-black-"+x,p[1].id="gradient-white-"+x,q[0].setAttribute("fill","url(#"+p[1].id+")"),q[1].setAttribute("fill","url(#"+p[0].id+")"),this.slideElement.appendChild(l),this.pickerElement.appendChild(m),x++}else this.slideElement.innerHTML=slide,this.pickerElement.innerHTML=picker;addEventListener(this.slideElement,"click",slideListener(this,this.slideElement,this.pickerElement)),addEventListener(this.pickerElement,"click",pickerListener(this,this.pickerElement)),enableDragging(this,this.slideElement,slideListener(this,this.slideElement,this.pickerElement)),enableDragging(this,this.pickerElement,pickerListener(this,this.pickerElement))}function addEventListener(a,b,c){a.attachEvent?a.attachEvent("on"+b,c):a.addEventListener&&a.addEventListener(b,c,!1)}function enableDragging(b,c,d){var e=!1;addEventListener(c,"mousedown",function(a){e=!0}),addEventListener(c,"mouseup",function(a){e=!1}),addEventListener(c,"mouseout",function(a){e=!1}),addEventListener(c,"mousemove",function(a){e&&d(a)})}function setColor(a,b,d,e){a.h=b.h%360,a.s=b.s,a.v=b.v;var c=hsv2rgb(a),f={y:a.h*a.slideElement.offsetHeight/360,x:0},g=a.pickerElement.offsetHeight,h={x:a.s*a.pickerElement.offsetWidth,y:g-a.v*g};return a.pickerElement.style.backgroundColor=hsv2rgb({h:a.h,s:1,v:1}).hex,a.callback&&a.callback(e||c.hex,{h:a.h,s:a.s,v:a.v},d||{r:c.r,g:c.g,b:c.b},h,f),a}var picker,slide,v=s.SVGAngle||t.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")?"SVG":"VML",hueOffset=15,svgNS="http://www.w3.org/2000/svg",w=['<div class="picker-wrapper">','<div class="picker"></div>','<div class="picker-indicator"></div>',"</div>",'<div class="slide-wrapper">','<div class="slide"></div>','<div class="slide-indicator"></div>',"</div>"].join("");"SVG"==v?(slide=$("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",width:"100%",height:"100%"},[$("defs",{},$("linearGradient",{id:"gradient-hsv",x1:"0%",y1:"100%",x2:"0%",y2:"0%"},[$("stop",{offset:"0%","stop-color":"#FF0000","stop-opacity":"1"}),$("stop",{offset:"13%","stop-color":"#FF00FF","stop-opacity":"1"}),$("stop",{offset:"25%","stop-color":"#8000FF","stop-opacity":"1"}),$("stop",{offset:"38%","stop-color":"#0040FF","stop-opacity":"1"}),$("stop",{offset:"50%","stop-color":"#00FFFF","stop-opacity":"1"}),$("stop",{offset:"63%","stop-color":"#00FF40","stop-opacity":"1"}),$("stop",{offset:"75%","stop-color":"#0BED00","stop-opacity":"1"}),$("stop",{offset:"88%","stop-color":"#FFFF00","stop-opacity":"1"}),$("stop",{offset:"100%","stop-color":"#FF0000","stop-opacity":"1"})])),$("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-hsv)"})]),picker=$("svg",{xmlns:"http://www.w3.org/2000/svg",version:"1.1",width:"100%",height:"100%"},[$("defs",{},[$("linearGradient",{id:"gradient-black",x1:"0%",y1:"100%",x2:"0%",y2:"0%"},[$("stop",{offset:"0%","stop-color":"#000000","stop-opacity":"1"}),$("stop",{offset:"100%","stop-color":"#CC9A81","stop-opacity":"0"})]),$("linearGradient",{id:"gradient-white",x1:"0%",y1:"100%",x2:"100%",y2:"100%"},[$("stop",{offset:"0%","stop-color":"#FFFFFF","stop-opacity":"1"}),$("stop",{offset:"100%","stop-color":"#CC9A81","stop-opacity":"0"})])]),$("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-white)"}),$("rect",{x:"0",y:"0",width:"100%",height:"100%",fill:"url(#gradient-black)"})])):"VML"==v&&(slide=['<DIV style="position: relative; width: 100%; height: 100%">','<v:rect style="position: absolute; top: 0; left: 0; width: 100%; height: 100%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="0" color="red" color2="red" colors="8519f fuchsia;.25 #8000ff;24903f #0040ff;.5 aqua;41287f #00ff40;.75 #0bed00;57671f yellow"></v:fill>',"</v:rect>","</DIV>"].join(""),picker=['<DIV style="position: relative; width: 100%; height: 100%">','<v:rect style="position: absolute; left: -1px; top: -1px; width: 101%; height: 101%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="270" color="#FFFFFF" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>',"</v:rect>",'<v:rect style="position: absolute; left: 0px; top: 0px; width: 100%; height: 101%" stroked="f" filled="t">','<v:fill type="gradient" method="none" angle="0" color="#000000" opacity="100%" color2="#CC9A81" o:opacity2="0%"></v:fill>',"</v:rect>","</DIV>"].join(""),t.namespaces.v||t.namespaces.add("v","urn:schemas-microsoft-com:vml","#default#VML"));var x=0;ColorPicker.hsv2rgb=function(a){var b=hsv2rgb(a);return delete b.hex,b},ColorPicker.hsv2hex=function(a){return hsv2rgb(a).hex},ColorPicker.rgb2hsv=rgb2hsv,ColorPicker.rgb2hex=function(a){return hsv2rgb(rgb2hsv(a)).hex},ColorPicker.hex2hsv=function(a){return rgb2hsv(ColorPicker.hex2rgb(a))},ColorPicker.hex2rgb=function(a){return{r:parseInt(a.substr(1,2),16),g:parseInt(a.substr(3,2),16),b:parseInt(a.substr(5,2),16)}},ColorPicker.prototype.setHsv=function(a){return setColor(this,a)},ColorPicker.prototype.setRgb=function(a){return setColor(this,rgb2hsv(a),a)},ColorPicker.prototype.setHex=function(a){return setColor(this,ColorPicker.hex2hsv(a),u,a)},ColorPicker.positionIndicators=function(a,b,c,d){c&&(b.style.left="auto",b.style.right="0px",b.style.top="0px",a.style.top=c.y-a.offsetHeight/2+"px"),d&&(b.style.top=d.y-b.offsetHeight/2+"px",b.style.left=d.x-b.offsetWidth/2+"px")},ColorPicker.fixIndicators=function(a,b){b.style.pointerEvents="none",a.style.pointerEvents="none"},s.ColorPicker=ColorPicker}(window,window.document),!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?module.exports=b():"function"==typeof define&&define.amd?define(b):a.PointerEventsPolyfill=b()}(this,function(){"use strict";function a(){if(k){var a=new Map;return a.pointers=l,a}this.keys=[],this.values=[]}function b(a,b,c,d){this.addCallback=a.bind(d),this.removeCallback=b.bind(d),this.changedCallback=c.bind(d),x&&(this.observer=new x(this.mutationWatcher.bind(this)))}function c(a,b){b=b||Object.create(null);var c=document.createEvent("Event");c.initEvent(a,b.bubbles||!1,b.cancelable||!1);for(var d,e=2;e<B.length;e++)d=B[e],c[d]=b[d]||C[e];c.buttons=b.buttons||0;var f=0;return f=b.pressure?b.pressure:c.buttons?.5:0,c.x=c.clientX,c.y=c.clientY,c.pointerId=b.pointerId||0,c.width=b.width||0,c.height=b.height||0,c.pressure=f,c.tiltX=b.tiltX||0,c.tiltY=b.tiltY||0,c.pointerType=b.pointerType||"",c.hwTimestamp=b.hwTimestamp||0,c.isPrimary=b.isPrimary||!1,c}function d(a){return"body /shadow-deep/ "+e(a)}function e(a){return'[touch-action="'+a+'"]'}function f(a){return"{ -ms-touch-action: "+a+"; touch-action: "+a+"; touch-action-delay: none; }"}function g(){if(G){E.forEach(function(a){String(a)===a?(F+=e(a)+f(a)+"\n",H&&(F+=d(a)+f(a)+"\n")):(F+=a.selectors.map(e)+f(a.rule)+"\n",H&&(F+=a.selectors.map(d)+f(a.rule)+"\n"))});var a=document.createElement("style");a.textContent=F,document.head.appendChild(a)}}function h(){if(!window.PointerEvent){if(window.PointerEvent=D,window.navigator.msPointerEnabled){var a=window.navigator.msMaxTouchPoints;Object.defineProperty(window.navigator,"maxTouchPoints",{value:a,enumerable:!0}),r.registerSource("ms",da)}else r.registerSource("mouse",P),void 0!==window.ontouchstart&&r.registerSource("touch",_);r.register(document)}}function i(a){if(!r.pointermap.has(a))throw new Error("InvalidPointerId")}function j(){window.Element&&!Element.prototype.setPointerCapture&&Object.defineProperties(Element.prototype,{setPointerCapture:{value:Z},releasePointerCapture:{value:$}})}var k=window.Map&&window.Map.prototype.forEach,l=function(){return this.size};a.prototype={set:function(a,b){var c=this.keys.indexOf(a);c>-1?this.values[c]=b:(this.keys.push(a),this.values.push(b))},has:function(a){return this.keys.indexOf(a)>-1},delete:function(a){var b=this.keys.indexOf(a);b>-1&&(this.keys.splice(b,1),this.values.splice(b,1))},get:function(a){var b=this.keys.indexOf(a);return this.values[b]},clear:function(){this.keys.length=0,this.values.length=0},forEach:function(a,b){this.values.forEach(function(c,d){a.call(b,c,this.keys[d],this)},this)},pointers:function(){return this.keys.length}};var m=a,n=["bubbles","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget","buttons","pointerId","width","height","pressure","tiltX","tiltY","pointerType","hwTimestamp","isPrimary","type","target","currentTarget","which","pageX","pageY","timeStamp"],o=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0,0,0,0,0,0,"",0,!1,"",null,null,0,0,0,0],p="undefined"!=typeof SVGElementInstance,q={pointermap:new m,eventMap:Object.create(null),captureInfo:Object.create(null),eventSources:Object.create(null),eventSourceList:[],registerSource:function(a,b){var c=b,d=c.events;d&&(d.forEach(function(a){c[a]&&(this.eventMap[a]=c[a].bind(c))},this),this.eventSources[a]=c,this.eventSourceList.push(c))},register:function(a){for(var b,c=this.eventSourceList.length,d=0;c>d&&(b=this.eventSourceList[d]);d++)b.register.call(b,a)},unregister:function(a){for(var b,c=this.eventSourceList.length,d=0;c>d&&(b=this.eventSourceList[d]);d++)b.unregister.call(b,a)},contains:function(a,b){return a.contains(b)},down:function(a){a.bubbles=!0,this.fireEvent("pointerdown",a)},move:function(a){a.bubbles=!0,this.fireEvent("pointermove",a)},up:function(a){a.bubbles=!0,this.fireEvent("pointerup",a)},enter:function(a){a.bubbles=!1,this.fireEvent("pointerenter",a)},leave:function(a){a.bubbles=!1,this.fireEvent("pointerleave",a)},over:function(a){a.bubbles=!0,this.fireEvent("pointerover",a)},out:function(a){a.bubbles=!0,this.fireEvent("pointerout",a)},cancel:function(a){a.bubbles=!0,this.fireEvent("pointercancel",a)},leaveOut:function(a){this.out(a),this.contains(a.target,a.relatedTarget)||this.leave(a)},enterOver:function(a){this.over(a),this.contains(a.target,a.relatedTarget)||this.enter(a)},eventHandler:function(a){if(!a._handledByPE){var b=a.type,c=this.eventMap&&this.eventMap[b];c&&c(a),a._handledByPE=!0}},listen:function(a,b){b.forEach(function(b){this.addEvent(a,b)},this)},unlisten:function(a,b){b.forEach(function(b){this.removeEvent(a,b)},this)},addEvent:function(a,b){a.addEventListener(b,this.boundHandler)},removeEvent:function(a,b){a.removeEventListener(b,this.boundHandler)},makeEvent:function(a,b){this.captureInfo[b.pointerId]&&(b.relatedTarget=null);var c=new PointerEvent(a,b);return b.preventDefault&&(c.preventDefault=b.preventDefault),c._target=c._target||b.target,c},fireEvent:function(a,b){var c=this.makeEvent(a,b);return this.dispatchEvent(c)},cloneEvent:function(a){for(var b,c=Object.create(null),d=0;d<n.length;d++)b=n[d],c[b]=a[b]||o[d],!p||"target"!==b&&"relatedTarget"!==b||c[b]instanceof SVGElementInstance&&(c[b]=c[b].correspondingUseElement);return a.preventDefault&&(c.preventDefault=function(){a.preventDefault()}),c},getTarget:function(a){return this.captureInfo[a.pointerId]||a._target},setCapture:function(a,b){this.captureInfo[a]&&this.releaseCapture(a),this.captureInfo[a]=b;var c=document.createEvent("Event");c.initEvent("gotpointercapture",!0,!1),c.pointerId=a,this.implicitRelease=this.releaseCapture.bind(this,a),document.addEventListener("pointerup",this.implicitRelease),document.addEventListener("pointercancel",this.implicitRelease),c._target=b,this.asyncDispatchEvent(c)},releaseCapture:function(a){var b=this.captureInfo[a];if(b){var c=document.createEvent("Event");c.initEvent("lostpointercapture",!0,!1),c.pointerId=a,this.captureInfo[a]=void 0,document.removeEventListener("pointerup",this.implicitRelease),document.removeEventListener("pointercancel",this.implicitRelease),c._target=b,this.asyncDispatchEvent(c)}},dispatchEvent:function(a){var b=this.getTarget(a);return b?b.dispatchEvent(a):void 0},asyncDispatchEvent:function(a){requestAnimationFrame(this.dispatchEvent.bind(this,a))}};q.boundHandler=q.eventHandler.bind(q);var r=q,s={shadow:function(a){return a?a.shadowRoot||a.webkitShadowRoot:void 0},canTarget:function(a){return a&&Boolean(a.elementFromPoint)},targetingShadow:function(a){var b=this.shadow(a);return this.canTarget(b)?b:void 0},olderShadow:function(a){var b=a.olderShadowRoot;if(!b){var c=a.querySelector("shadow");c&&(b=c.olderShadowRoot)}return b},allShadows:function(a){for(var b=[],c=this.shadow(a);c;)b.push(c),c=this.olderShadow(c);return b},searchRoot:function(a,b,c){if(a){var d,e,f=a.elementFromPoint(b,c);for(e=this.targetingShadow(f);e;){if(d=e.elementFromPoint(b,c)){
var g=this.targetingShadow(d);return this.searchRoot(g,b,c)||d}e=this.olderShadow(e)}return f}},owner:function(a){for(var b=a;b.parentNode;)b=b.parentNode;return b.nodeType!=Node.DOCUMENT_NODE&&b.nodeType!=Node.DOCUMENT_FRAGMENT_NODE&&(b=document),b},findTarget:function(a){var b=a.clientX,c=a.clientY,d=this.owner(a.target);return d.elementFromPoint(b,c)||(d=document),this.searchRoot(d,b,c)}},t=Array.prototype.forEach.call.bind(Array.prototype.forEach),u=Array.prototype.map.call.bind(Array.prototype.map),v=Array.prototype.slice.call.bind(Array.prototype.slice),w=Array.prototype.filter.call.bind(Array.prototype.filter),x=window.MutationObserver||window.WebKitMutationObserver,y="[touch-action]",z={subtree:!0,childList:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["touch-action"]};b.prototype={watchSubtree:function(a){s.canTarget(a)&&this.observer.observe(a,z)},enableOnSubtree:function(a){this.watchSubtree(a),a===document&&"complete"!==document.readyState?this.installOnLoad():this.installNewSubtree(a)},installNewSubtree:function(a){t(this.findElements(a),this.addElement,this)},findElements:function(a){return a.querySelectorAll?a.querySelectorAll(y):[]},removeElement:function(a){this.removeCallback(a)},addElement:function(a){this.addCallback(a)},elementChanged:function(a,b){this.changedCallback(a,b)},concatLists:function(a,b){return a.concat(v(b))},installOnLoad:function(){document.addEventListener("readystatechange",function(){"complete"===document.readyState&&this.installNewSubtree(document)}.bind(this))},isElement:function(a){return a.nodeType===Node.ELEMENT_NODE},flattenMutationTree:function(a){var b=u(a,this.findElements,this);return b.push(w(a,this.isElement)),b.reduce(this.concatLists,[])},mutationWatcher:function(a){a.forEach(this.mutationHandler,this)},mutationHandler:function(a){if("childList"===a.type){var b=this.flattenMutationTree(a.addedNodes);b.forEach(this.addElement,this);var c=this.flattenMutationTree(a.removedNodes);c.forEach(this.removeElement,this)}else"attributes"===a.type&&this.elementChanged(a.target,a.oldValue)}},x||(b.prototype.watchSubtree=function(){console.warn("PointerEventsPolyfill: MutationObservers not found, touch-action will not be dynamically detected")});var A=b,B=["bubbles","cancelable","view","detail","screenX","screenY","clientX","clientY","ctrlKey","altKey","shiftKey","metaKey","button","relatedTarget","pageX","pageY"],C=[!1,!1,null,null,0,0,0,0,!1,!1,!1,!1,0,null,0,0],D=c,E=["none","auto","pan-x","pan-y",{rule:"pan-x pan-y",selectors:["pan-x pan-y","pan-y pan-x"]}],F="",G=(document.head,window.PointerEvent||window.MSPointerEvent),H=!window.ShadowDOMPolyfill&&document.head.createShadowRoot,I=r.pointermap,J=25,K=[0,1,4,2],L=!1;try{L=1===new MouseEvent("test",{buttons:1}).buttons}catch(M){}var N,O={POINTER_ID:1,POINTER_TYPE:"mouse",events:["mousedown","mousemove","mouseup","mouseover","mouseout"],register:function(a){r.listen(a,this.events)},unregister:function(a){r.unlisten(a,this.events)},lastTouches:[],isEventSimulatedFromTouch:function(a){for(var b,c=this.lastTouches,d=a.clientX,e=a.clientY,f=0,g=c.length;g>f&&(b=c[f]);f++){var h=Math.abs(d-b.x),i=Math.abs(e-b.y);if(J>=h&&J>=i)return!0}},prepareEvent:function(a){var b=r.cloneEvent(a),c=b.preventDefault;return b.preventDefault=function(){a.preventDefault(),c()},b.pointerId=this.POINTER_ID,b.isPrimary=!0,b.pointerType=this.POINTER_TYPE,L||(b.buttons=K[b.which]||0),b},mousedown:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=I.has(this.POINTER_ID);b&&this.cancel(a);var c=this.prepareEvent(a);I.set(this.POINTER_ID,a),r.down(c)}},mousemove:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);r.move(b)}},mouseup:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=I.get(this.POINTER_ID);if(b&&b.button===a.button){var c=this.prepareEvent(a);r.up(c),this.cleanupMouse()}}},mouseover:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);r.enterOver(b)}},mouseout:function(a){if(!this.isEventSimulatedFromTouch(a)){var b=this.prepareEvent(a);r.leaveOut(b)}},cancel:function(a){var b=this.prepareEvent(a);r.cancel(b),this.cleanupMouse()},cleanupMouse:function(){I.delete(this.POINTER_ID)}},P=O,Q=r.captureInfo,R=s.findTarget.bind(s),S=s.allShadows.bind(s),T=r.pointermap,U=(Array.prototype.map.call.bind(Array.prototype.map),2500),V=200,W="touch-action",X=!1,Y={events:["touchstart","touchmove","touchend","touchcancel"],register:function(a){X?r.listen(a,this.events):N.enableOnSubtree(a)},unregister:function(a){X&&r.unlisten(a,this.events)},elementAdded:function(a){var b=a.getAttribute(W),c=this.touchActionToScrollType(b);c&&(a._scrollType=c,r.listen(a,this.events),S(a).forEach(function(a){a._scrollType=c,r.listen(a,this.events)},this))},elementRemoved:function(a){a._scrollType=void 0,r.unlisten(a,this.events),S(a).forEach(function(a){a._scrollType=void 0,r.unlisten(a,this.events)},this)},elementChanged:function(a,b){var c=a.getAttribute(W),d=this.touchActionToScrollType(c),e=this.touchActionToScrollType(b);d&&e?(a._scrollType=d,S(a).forEach(function(a){a._scrollType=d},this)):e?this.elementRemoved(a):d&&this.elementAdded(a)},scrollTypes:{EMITTER:"none",XSCROLLER:"pan-x",YSCROLLER:"pan-y",SCROLLER:/^(?:pan-x pan-y)|(?:pan-y pan-x)|auto$/},touchActionToScrollType:function(a){var b=a,c=this.scrollTypes;return"none"===b?"none":b===c.XSCROLLER?"X":b===c.YSCROLLER?"Y":c.SCROLLER.exec(b)?"XY":void 0},POINTER_TYPE:"touch",firstTouch:null,isPrimaryTouch:function(a){return this.firstTouch===a.identifier},setPrimaryTouch:function(a){(0===T.pointers()||1===T.pointers()&&T.has(1))&&(this.firstTouch=a.identifier,this.firstXY={X:a.clientX,Y:a.clientY},this.scrolling=!1,this.cancelResetClickCount())},removePrimaryPointer:function(a){a.isPrimary&&(this.firstTouch=null,this.firstXY=null,this.resetClickCount())},clickCount:0,resetId:null,resetClickCount:function(){var a=function(){this.clickCount=0,this.resetId=null}.bind(this);this.resetId=setTimeout(a,V)},cancelResetClickCount:function(){this.resetId&&clearTimeout(this.resetId)},typeToButtons:function(a){var b=0;return("touchstart"===a||"touchmove"===a)&&(b=1),b},touchToPointer:function(a){var b=this.currentTouchEvent,c=r.cloneEvent(a),d=c.pointerId=a.identifier+2;c.target=Q[d]||R(c),c.bubbles=!0,c.cancelable=!0,c.detail=this.clickCount,c.button=0,c.buttons=this.typeToButtons(b.type),c.width=a.webkitRadiusX||a.radiusX||0,c.height=a.webkitRadiusY||a.radiusY||0,c.pressure=a.webkitForce||a.force||.5,c.isPrimary=this.isPrimaryTouch(a),c.pointerType=this.POINTER_TYPE;var e=this;return c.preventDefault=function(){e.scrolling=!1,e.firstXY=null,b.preventDefault()},c},processTouches:function(a,b){var c=a.changedTouches;this.currentTouchEvent=a;for(var d,e=0;e<c.length;e++)d=c[e],b.call(this,this.touchToPointer(d))},shouldScroll:function(a){if(this.firstXY){var b,c=a.currentTarget._scrollType;if("none"===c)b=!1;else if("XY"===c)b=!0;else{var d=a.changedTouches[0],e=c,f="Y"===c?"X":"Y",g=Math.abs(d["client"+e]-this.firstXY[e]),h=Math.abs(d["client"+f]-this.firstXY[f]);b=g>=h}return this.firstXY=null,b}},findTouch:function(a,b){for(var c,d=0,e=a.length;e>d&&(c=a[d]);d++)if(c.identifier===b)return!0},vacuumTouches:function(a){var b=a.touches;if(T.pointers()>=b.length){var c=[];T.forEach(function(a,d){if(1!==d&&!this.findTouch(b,d-2)){var e=a.out;c.push(e)}},this),c.forEach(this.cancelOut,this)}},touchstart:function(a){this.vacuumTouches(a),this.setPrimaryTouch(a.changedTouches[0]),this.dedupSynthMouse(a),this.scrolling||(this.clickCount++,this.processTouches(a,this.overDown))},overDown:function(a){T.set(a.pointerId,{target:a.target,out:a,outTarget:a.target}),r.over(a),r.enter(a),r.down(a)},touchmove:function(a){this.scrolling||(this.shouldScroll(a)?(this.scrolling=!0,this.touchcancel(a)):(a.preventDefault(),this.processTouches(a,this.moveOverOut)))},moveOverOut:function(a){var b=a,c=T.get(b.pointerId);if(c){var d=c.out,e=c.outTarget;r.move(b),d&&e!==b.target&&(d.relatedTarget=b.target,b.relatedTarget=e,d.target=e,b.target?(r.leaveOut(d),r.enterOver(b)):(b.target=e,b.relatedTarget=null,this.cancelOut(b))),c.out=b,c.outTarget=b.target}},touchend:function(a){this.dedupSynthMouse(a),this.processTouches(a,this.upOut)},upOut:function(a){this.scrolling||(r.up(a),r.out(a),r.leave(a)),this.cleanUpPointer(a)},touchcancel:function(a){this.processTouches(a,this.cancelOut)},cancelOut:function(a){r.cancel(a),r.out(a),r.leave(a),this.cleanUpPointer(a)},cleanUpPointer:function(a){T.delete(a.pointerId),this.removePrimaryPointer(a)},dedupSynthMouse:function(a){var b=P.lastTouches,c=a.changedTouches[0];if(this.isPrimaryTouch(c)){var d={x:c.clientX,y:c.clientY};b.push(d);var e=function(a,b){var c=a.indexOf(b);c>-1&&a.splice(c,1)}.bind(null,b,d);setTimeout(e,U)}}};X||(N=new A(Y.elementAdded,Y.elementRemoved,Y.elementChanged,Y));var Z,$,_=Y,aa=r.pointermap,ba=window.MSPointerEvent&&"number"==typeof window.MSPointerEvent.MSPOINTER_TYPE_MOUSE,ca={events:["MSPointerDown","MSPointerMove","MSPointerUp","MSPointerOut","MSPointerOver","MSPointerCancel","MSGotPointerCapture","MSLostPointerCapture"],register:function(a){r.listen(a,this.events)},unregister:function(a){r.unlisten(a,this.events)},POINTER_TYPES:["","unavailable","touch","pen","mouse"],prepareEvent:function(a){var b=a;return ba&&(b=r.cloneEvent(a),b.pointerType=this.POINTER_TYPES[a.pointerType]),b},cleanup:function(a){aa.delete(a)},MSPointerDown:function(a){aa.set(a.pointerId,a);var b=this.prepareEvent(a);r.down(b)},MSPointerMove:function(a){var b=this.prepareEvent(a);r.move(b)},MSPointerUp:function(a){var b=this.prepareEvent(a);r.up(b),this.cleanup(a.pointerId)},MSPointerOut:function(a){var b=this.prepareEvent(a);r.leaveOut(b)},MSPointerOver:function(a){var b=this.prepareEvent(a);r.enterOver(b)},MSPointerCancel:function(a){var b=this.prepareEvent(a);r.cancel(b),this.cleanup(a.pointerId)},MSLostPointerCapture:function(a){var b=r.makeEvent("lostpointercapture",a);r.dispatchEvent(b)},MSGotPointerCapture:function(a){var b=r.makeEvent("gotpointercapture",a);r.dispatchEvent(b)}},da=ca,ea=window.navigator;ea.msPointerEnabled?(Z=function(a){i(a),this.msSetPointerCapture(a)},$=function(a){i(a),this.msReleasePointerCapture(a)}):(Z=function(a){i(a),r.setCapture(a,this)},$=function(a){i(a),r.releaseCapture(a,this)}),g(),h(),j();var fa={dispatcher:r,Installer:A,PointerEvent:D,PointerMap:m,targetFinding:s};return fa});var Utils={DIALOG_TRANSITION_DURATION:200,isApple:navigator.userAgent.indexOf("Mac")!==-1,clearCanvas:function(cxt){cxt.clearRect(0,0,cxt.canvas.width,cxt.canvas.height)},getCanvasX:function(pageX){return pageX-preCanvas.offsetLeft},getCanvasY:function(pageY){return pageY-preCanvas.offsetTop},colorToRGB:function(cssColor){if("#"===cssColor.charAt(0)){var result=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})$/i.exec(cssColor);if(result)return{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}}return{black:{r:0,g:0,b:0},blue:{r:0,g:0,b:255},brown:{r:165,g:42,b:42},cyan:{r:0,g:255,b:255},gray:{r:128,g:128,b:128},green:{r:0,g:128,b:0},indigo:{r:75,g:0,b:130},lightblue:{r:173,g:216,b:230},lime:{r:0,g:255,b:0},magenta:{r:255,g:0,b:255},navy:{r:0,g:0,b:128},olive:{r:128,g:128,b:0},orange:{r:255,g:165,b:0},purple:{r:128,g:0,b:128},red:{r:255,g:0,b:0},teal:{r:0,g:128,b:128},violet:{r:238,g:130,b:238},white:{r:255,g:255,b:255},yellow:{r:255,g:255,b:0}}[cssColor]},isPointInRect:function(px,py,rx,ry,rw,rh){return px>rx&&px<rx+rw&&py>ry&&py<ry+rh},makeDialog:function(element,trigger){function setDialogTransformOrigin(){"undefined"!=typeof trigger&&(element.style.WebkitTransformOrigin=element.style.MozTransformOrigin=element.style.MsTransformOrigin=element.style.OTransformOrigin=element.style.transformOrigin=trigger.offsetLeft-toolbar.scrollLeft-element.offsetLeft+"px "+(trigger.offsetTop-element.offsetTop)+"px",element.offsetLeft)}var toolbar=document.getElementById("toolbar"),dialogsContainer=document.getElementById("dialogs");element.open=function(){keyManager.disableAppShortcuts(),dialogsContainer.style.display="block",element.classList.add("visible"),setDialogTransformOrigin(),setTimeout(function(){dialogsContainer.classList.add("visible"),element.classList.add("open");var firstInput=element.querySelector("input, select, textarea");if(firstInput)firstInput.focus();else{var submitButton=element.querySelector('button[type="submit"]');submitButton&&submitButton.focus()}},1)},element.close=function(e){e&&e.preventDefault&&e.preventDefault(),setDialogTransformOrigin(),element.classList.remove("open"),dialogsContainer.classList.remove("visible"),setTimeout(function(){element.classList.remove("visible"),dialogsContainer.style.display="none",keyManager.enableAppShortcuts()},Utils.DIALOG_TRANSITION_DURATION)},element instanceof HTMLFormElement&&(element.onsubmit=function(e){e.target.close()})},raf:(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(func){setTimeout(func,1e3/60)}).bind(window)},keyManager={_enabled:!1,_handleKeyDown:function(e){var ctrlOrCmd=!Utils.isApple&&e.ctrlKey||Utils.isApple&&e.metaKey,noModifiers=!(e.shiftKey||e.ctrlKey||e.altKey||e.metaKey);switch(e.keyCode){case 8:"selection"===localStorage.tool&&(e.preventDefault(),tools.selection.clear());break;case 46:"selection"===localStorage.tool&&(e.preventDefault(),tools.selection.clear());break;case 65:ctrlOrCmd&&(e.preventDefault(),switchTool("selection"),tools.selection.selectAll(canvas.width,canvas.height));break;case 66:if(e.preventDefault(),!ctrlOrCmd){switchTool("doodle");break}case 67:if(e.preventDefault(),!ctrlOrCmd){switchTool("curve");break}case 68:ctrlOrCmd&&(e.preventDefault(),"selection"===localStorage.tool&&tools.selection.duplicate());break;case 69:noModifiers&&(e.preventDefault(),switchTool("eraser"));break;case 70:noModifiers&&(e.preventDefault(),switchTool("floodFill"));break;case 72:noModifiers&&(e.preventDefault(),switchTool("pan"));break;case 73:noModifiers&&(e.preventDefault(),switchTool("eyedropper"));break;case 76:noModifiers&&(e.preventDefault(),switchTool("line"));break;case 79:ctrlOrCmd?(e.preventDefault(),document.getElementById("upload").click()):noModifiers&&(e.preventDefault(),switchTool("oval"));break;case 80:noModifiers&&(e.preventDefault(),switchTool("pencil"));break;case 82:noModifiers&&(e.preventDefault(),switchTool("rect"));break;case 83:ctrlOrCmd?(e.preventDefault(),document.getElementById("saveDialog").open()):noModifiers&&(e.preventDefault(),switchTool("selection"));break;case 84:noModifiers&&(e.preventDefault(),switchTool("text"));break;case 88:if(noModifiers){e.preventDefault();var oldLine=localStorage.lineColor;localStorage.lineColor=localStorage.fillColor,localStorage.fillColor=oldLine,document.getElementById("colors").style.borderColor=localStorage.lineColor,document.getElementById("colors").style.backgroundColor=localStorage.fillColor}break;case 89:ctrlOrCmd&&(e.preventDefault(),undoStack.redo());break;case 90:ctrlOrCmd&&e.shiftKey?(e.preventDefault(),undoStack.redo()):ctrlOrCmd&&(e.preventDefault(),undoStack.undo());break;case 187:ctrlOrCmd&&e.altKey&&(e.preventDefault(),zoomManager.zoomIn());break;case 189:ctrlOrCmd&&e.altKey&&(e.preventDefault(),zoomManager.zoomOut());break;case 191:e.shiftKey&&(e.preventDefault(),document.getElementById("keyboardDialog").open());break;case 219:if(noModifiers){e.preventDefault();var lineWidthSelect=document.getElementById("lineWidth");lineWidthSelect.selectedIndex>0&&(localStorage.lineWidth=lineWidthSelect.value=lineWidthSelect.options[lineWidthSelect.selectedIndex-1].value)}break;case 221:if(noModifiers){e.preventDefault();var lineWidthSelect=document.getElementById("lineWidth");lineWidthSelect.selectedIndex<lineWidthSelect.options.length-1&&(localStorage.lineWidth=lineWidthSelect.value=lineWidthSelect.options[lineWidthSelect.selectedIndex+1].value)}}},enableAppShortcuts:function(){this._enabled||(window.addEventListener("keydown",this._handleKeyDown,!1),this._enabled=!0)},disableAppShortcuts:function(){this._enabled&&(window.removeEventListener("keydown",this._handleKeyDown,!1),this._enabled=!1)}},undoStack={_undoStack:[],_redoStack:[],_currentState:void 0,_applyState:function(state){this._currentState=state,canvas.width=state.width,preCanvas.width=state.width,localStorage.width=state.width,canvas.height=state.height,preCanvas.height=state.height,localStorage.height=state.height,cxt.drawImage(state.image,0,0)},_updateUI:function(){0===this._redoStack.length?document.getElementById("redoBtn").disabled=!0:document.getElementById("redoBtn").disabled=!1,0===this._undoStack.length?document.getElementById("undoBtn").disabled=!0:document.getElementById("undoBtn").disabled=!1},addState:function(){this._currentState&&this._undoStack.push(this._currentState)>localStorage.maxUndoStackDepth&&this._undoStack.splice(0,1);var image=new Image;image.src=canvas.toDataURL(),this._currentState={image:image,width:canvas.width,height:canvas.height},this._redoStack=[],this._updateUI()},clear:function(){this._undoStack=[],this._redoStack=[],this._currentState=void 0,this.addState(),this._updateUI()},redo:function(){if(0===this._redoStack.length)return void this._updateUI();tools[localStorage.tool].deactivate();var restoreState=this._redoStack.pop();this._undoStack.push(this._currentState),this._applyState(restoreState),this._updateUI(),tools[localStorage.tool].activate()},undo:function(){if(0===this._undoStack.length)return void this._updateUI();tools[localStorage.tool].deactivate();var restoreState=this._undoStack.pop();this._redoStack.push(this._currentState),this._applyState(restoreState),this._updateUI(),tools[localStorage.tool].activate()}},zoomManager={ZOOM_LEVELS:[25,50,75,100,200,400,800],_zoomPercentField:void 0,_zoomSlider:void 0,_zoomOutBtn:void 0,_zoomInBtn:void 0,_zoomLevel:1,get level(){return this._zoomLevel},set level(percent){percent=Math.round(percent),isNaN(percent)||percent<1||percent>999||(this._zoomLevel=percent/100,this._zoomPercentField.value=percent,this._zoomSlider.value=this._nearestZoomLevel(percent),canvas.style.WebkitTransform=canvas.style.MozTransform=canvas.style.MsTransform=canvas.style.OTransform=canvas.style.transform=preCanvas.style.WebkitTransform=preCanvas.style.MozTransform=preCanvas.style.MsTransform=preCanvas.style.OTransform=preCanvas.style.transform="scale("+percent/100+")",tools[localStorage.tool].activate())},_nearestZoomLevel:function(percent){var i=0;for(i=0;i<this.ZOOM_LEVELS.length-1;i++)if(percent<(this.ZOOM_LEVELS[i]+this.ZOOM_LEVELS[i+1])/2)return i;return i},init:function(){this._zoomPercentField=document.getElementById("zoomPercent"),this._zoomSlider=document.getElementById("zoomSlider"),this._zoomOutBtn=document.getElementById("zoomOutBtn"),this._zoomInBtn=document.getElementById("zoomInBtn"),this._zoomPercentField.value=100*this._zoomLevel,this._zoomSlider.min=0,this._zoomSlider.max=this.ZOOM_LEVELS.length-1;var that=this;this._zoomPercentField.oninput=function(){that.level=parseInt(this.value)},this._zoomSlider.oninput=function(){that.level=that.ZOOM_LEVELS[this.value]},this._zoomOutBtn.onclick=function(){that.zoomOut()},this._zoomInBtn.onclick=function(){that.zoomIn()}},zoomIn:function(){this._zoomSlider.stepUp(),this._zoomSlider.oninput()},zoomOut:function(){this._zoomSlider.stepDown(),this._zoomSlider.oninput()}};Tool.prototype._deAntiAlias=function(){for(var imageData=this._preCxt.getImageData(0,0,this._preCxt.canvas.width,this._preCxt.canvas.height),i=3;i<imageData.data.length;i+=4)imageData.data[i]>=128?imageData.data[i]=255:imageData.data[i]=0;this._preCxt.putImageData(imageData,0,0)},Tool.prototype._roundPointerState=function(pointerState){pointerState.x=Math.floor(pointerState.x),pointerState.y=Math.floor(pointerState.y)},Tool.prototype.activate=function(){this._preCxt.canvas.style.cursor="default"},Tool.prototype.start=function(pointerState){},Tool.prototype.move=function(pointerState){},Tool.prototype.end=function(pointerState){},Tool.prototype.deactivate=function(){},DrawingTool.prototype=Object.create(Tool.prototype),DrawingTool.prototype._prepareCanvas=function(){this._preCxt.lineWidth=this._lineWidth,this._preCxt.strokeStyle=this._lineColor,this._preCxt.fillStyle=this._fillColor},DrawingTool.prototype.activate=function(){this._preCxt.canvas.style.cursor="crosshair"},DrawingTool.prototype.start=function(pointerState){2!==pointerState.button?(this._lineColor=localStorage.lineColor,this._fillColor=localStorage.fillColor):(this._lineColor=localStorage.fillColor,this._fillColor=localStorage.lineColor),this._lineWidth=localStorage.lineWidth},DrawingTool.prototype.move=function(pointerState){this._prepareCanvas()},DrawingTool.prototype.end=function(pointerState){this._cxt.drawImage(this._preCxt.canvas,0,0),Utils.clearCanvas(this._preCxt),undoStack.addState()},ShapeTool.prototype=Object.create(DrawingTool.prototype),ShapeTool.prototype.start=function(pointerState){DrawingTool.prototype.start.apply(this,arguments),"fillOnly"===localStorage.outlineOption&&(this._lineColor="transparent"),"outlineOnly"===localStorage.outlineOption&&(this._fillColor="transparent"),this.startX=pointerState.x,this.startY=pointerState.y},ShapeTool.prototype.move=function(pointerState){DrawingTool.prototype.move.apply(this,arguments),Utils.clearCanvas(this._preCxt)},PencilTool.prototype=Object.create(DrawingTool.prototype),PencilTool.prototype._drawPoint=function(x,y,cxt){cxt.fillRect(x,y,1,1)},PencilTool.prototype._drawLine=function(x1,y1,x2,y2,cxt){for(var e2,dx=Math.abs(x2-x1),dy=-Math.abs(y2-y1),sx=x1<x2?1:-1,sy=y1<y2?1:-1,err=dx+dy;x1!==x2||y1!==y2;)e2=2*err,e2>=dy&&(err+=dy,x1+=sx),e2<=dx&&(err+=dx,y1+=sy),this._drawPoint(x1,y1,cxt)},PencilTool.prototype.activate=function(){this._preCxt.canvas.style.cursor="url(images/cursors/pencil.cur), crosshair"},PencilTool.prototype.start=function(pointerState){DrawingTool.prototype.start.apply(this,arguments),this._roundPointerState(pointerState),this._lastX=pointerState.x,this._lastY=pointerState.y;var cxt=localStorage.ghostDraw?this._preCxt:this._cxt;this._drawPoint(pointerState.x,pointerState.y,cxt)},PencilTool.prototype.move=function(pointerState){DrawingTool.prototype.move.apply(this,arguments),this._roundPointerState(pointerState);var cxt=localStorage.ghostDraw?this._preCxt:this._cxt;cxt.lineWidth=this._lineWidth,cxt.fillStyle=this._lineColor,this._drawLine(this._lastX,this._lastY,pointerState.x,pointerState.y,cxt),this._lastX=pointerState.x,this._lastY=pointerState.y},DoodleTool.prototype=Object.create(DrawingTool.prototype),DoodleTool.prototype._drawCap=function(cxt,x,y){cxt.fillStyle=this._lineColor,cxt.beginPath(),cxt.arc(x,y,this._lineWidth/2,0,2*Math.PI,!1),cxt.closePath(),cxt.fill()},DoodleTool.prototype.activate=function(){DrawingTool.prototype.activate.apply(this),this._preCxt.canvas.style.cursor=DoodleTool.getCursorCSS()},DoodleTool.prototype.start=function(pointerState){DrawingTool.prototype.start.apply(this,arguments),this._lastX=pointerState.x,this._lastY=pointerState.y;var cxt=localStorage.ghostDraw?this._preCxt:this._cxt;this._drawCap(cxt,pointerState.x,pointerState.y)},DoodleTool.prototype.move=function(pointerState){DrawingTool.prototype.move.apply(this,arguments);var cxt=localStorage.ghostDraw?this._preCxt:this._cxt;cxt.lineWidth=this._lineWidth,cxt.strokeStyle=this._lineColor,cxt.beginPath(),cxt.moveTo(this._lastX,this._lastY),cxt.lineTo(pointerState.x,pointerState.y),cxt.closePath(),cxt.stroke(),this._drawCap(cxt,pointerState.x,pointerState.y),this._lastX=pointerState.x,this._lastY=pointerState.y},DoodleTool.getCursorCSS=function(){var size=parseInt(localStorage.lineWidth)*zoomManager.level+2;if(cursorCanvas.width=cursorCanvas.height=Math.min(128,size),size>128*Math.sqrt(2))return"crosshair";cursorCxt.lineWidth=1,cursorCxt.strokeStyle="white",cursorCxt.beginPath(),cursorCxt.arc(cursorCanvas.width/2,cursorCanvas.height/2,localStorage.lineWidth*zoomManager.level/2,0,2*Math.PI,!1),cursorCxt.closePath(),cursorCxt.stroke(),cursorCxt.lineWidth=1,cursorCxt.strokeStyle="black",cursorCxt.beginPath(),cursorCxt.arc(cursorCanvas.width/2,cursorCanvas.height/2,localStorage.lineWidth*zoomManager.level/2,0,2*Math.PI,!1),cursorCxt.closePath(),cursorCxt.stroke();var cursorDataURL=cursorCanvas.toDataURL(),cursorCSS="url("+cursorDataURL+")";return cursorCSS+=" "+cursorCanvas.width/2+" "+cursorCanvas.height/2,cursorCSS+=", crosshair"},LineTool.prototype=Object.create(DrawingTool.prototype),LineTool.drawLine=function(x1,y1,x2,y2,cxt){cxt.lineWidth=this.lineWidth,cxt.strokeStyle=this.lineColor,cxt.beginPath(),cxt.moveTo(x1,y1),cxt.lineTo(x2,y2),cxt.closePath(),cxt.stroke()},LineTool.prototype.start=function(pointerState){DrawingTool.prototype.start.apply(this,arguments),localStorage.antiAlias||this._roundPointerState(pointerState),this.startX=pointerState.x,this.startY=pointerState.y},LineTool.prototype.move=function(pointerState){DrawingTool.prototype.move.apply(this,arguments),localStorage.antiAlias||this._roundPointerState(pointerState),Utils.clearCanvas(this._preCxt),LineTool.drawLine(this.startX,this.startY,pointerState.x,pointerState.y,this._preCxt),localStorage.antiAlias||this._deAntiAlias()},CurveTool.STATE_NOT_STARTED=0,CurveTool.STATE_LINE_DRAWN=1,CurveTool.prototype=Object.create(DrawingTool.prototype),CurveTool.prototype._plotQuadBezierSeg=function(x1,y1,x2,y2,x3,y3,cxt){var xy,dx,dy,err,sx=x2-x3,sy=y2-y3,xx=x1-x3,yy=y1-y3,cur=xx*sy-yy*sx;if(sx*sx+sy*sy>xx*xx+yy*yy&&(x2=x1,x1=sx+x3,y2=y1,y1=sy+y3,cur=-cur),0!=cur){xx+=sx,xx*=sx=x1<x2?1:-1,yy+=sy,yy*=sy=y1<y2?1:-1,xy=2*xx*yy,xx*=xx,yy*=yy,cur*sx*sy<0&&(xx=-xx,yy=-yy,xy=-xy,cur=-cur),dx=4*sy*cur*(x3-x1)+xx-xy,dy=4*sx*cur*(y1-y3)+yy-xy,xx+=xx,yy+=yy,err=dx+dy+xy;do{if(DoodleTool.prototype._drawCap.call(this,cxt,x1,y1),x1==x2&&y1==y2)return;y3=2*err<dx,2*err>dy&&(x1+=sx,dx-=xy,err+=dy+=yy),y3&&(y1+=sy,dy-=xy,err+=dx+=xx)}while(dy<0&&dx>0)}LineTool.drawLine(x1,y1,x2,y2,cxt)},CurveTool.prototype._plotQuadBezier=function(x1,y1,x2,y2,x3,y3,cxt){var r,x=x1-x3,y=y1-y3,t=x1-2*x3+x2;x*(x2-x3)>0&&(y*(y2-y3)>0&&Math.abs((y1-2*y3+y2)/t*x)>Math.abs(y)&&(x1=x2,x2=x+x3,y1=y2,y2=y+y3),t=(x1-x3)/t,r=(1-t)*((1-t)*y1+2*t*y3)+t*t*y2,t=(x1*x2-x3*x3)*t/(x1-x3),x=Math.floor(t+.5),y=Math.floor(r+.5),r=(y3-y1)*(t-x1)/(x3-x1)+y1,this._plotQuadBezierSeg(x1,y1,x,y,x,Math.floor(r+.5),cxt),r=(y3-y2)*(t-x2)/(x3-x2)+y2,x1=x3=x,y1=y,y3=Math.floor(r+.5)),(y1-y3)*(y2-y3)>0&&(t=y1-2*y3+y2,t=(y1-y3)/t,r=(1-t)*((1-t)*x1+2*t*x3)+t*t*x2,t=(y1*y2-y3*y3)*t/(y1-y3),x=Math.floor(r+.5),y=Math.floor(t+.5),r=(x3-x1)*(t-y1)/(y3-y1)+x1,this._plotQuadBezierSeg(x1,y1,x,y,Math.floor(r+.5),y,cxt),r=(x3-x2)*(t-y2)/(y3-y2)+x2,x1=x,x3=Math.floor(r+.5),y1=y3=y),this._plotQuadBezierSeg(x1,y1,x2,y2,x3,y3,cxt)},CurveTool.prototype.activate=function(){DrawingTool.prototype.activate.apply(this,arguments),this._state=CurveTool.STATE_NOT_STARTED},CurveTool.prototype.start=function(pointerState){DrawingTool.prototype.start.apply(this,arguments),localStorage.antiAlias||this._roundPointerState(pointerState),this._state===CurveTool.STATE_NOT_STARTED&&(this.startX=pointerState.x,this.startY=pointerState.y)},CurveTool.prototype.move=function(pointerState){DrawingTool.prototype.move.apply(this,arguments),localStorage.antiAlias||this._roundPointerState(pointerState),Utils.clearCanvas(this._preCxt),this._state===CurveTool.STATE_NOT_STARTED?LineTool.drawLine(this.startX,this.startY,pointerState.x,pointerState.y,this._preCxt):this._plotQuadBezier(this.startX,this.startY,this.endX,this.endY,pointerState.x,pointerState.y,this._preCxt),localStorage.antiAlias||this._deAntiAlias()},CurveTool.prototype.end=function(pointerState){this._state===CurveTool.STATE_NOT_STARTED?(localStorage.antiAlias||this._roundPointerState(pointerState),this.endX=pointerState.x,this.endY=pointerState.y,this._state=CurveTool.STATE_LINE_DRAWN):(this._cxt.drawImage(this._preCxt.canvas,0,0),Utils.clearCanvas(this._preCxt),undoStack.addState(),this._state=CurveTool.STATE_NOT_STARTED)},RectangleTool.prototype=Object.create(ShapeTool.prototype),RectangleTool.prototype.move=function(pointerState){ShapeTool.prototype.move.apply(this,arguments),localStorage.antiAlias||this._roundPointerState(pointerState);var x=Math.min(pointerState.x,this.startX),y=Math.min(pointerState.y,this.startY),width=Math.abs(pointerState.x-this.startX),height=Math.abs(pointerState.y-this.startY);this._preCxt.strokeRect(x,y,width,height),localStorage.antiAlias||this._deAntiAlias(),this._preCxt.globalCompositeOperation="destination-over",this._preCxt.fillRect(x,y,width,height),this._preCxt.globalCompositeOperation="source-over","fillOnly"!==localStorage.outlineOption||localStorage.antiAlias||this._deAntiAlias()},OvalTool.prototype=Object.create(ShapeTool.prototype),OvalTool.prototype.move=function(pointerState){ShapeTool.prototype.move.apply(this,arguments),localStorage.antiAlias||this._roundPointerState(pointerState);var centerX=(pointerState.x+this.startX)/2,centerY=(pointerState.y+this.startY)/2,radX=(pointerState.x-this.startX)/2,radY=(pointerState.y-this.startY)/2;this._preCxt.lineWidth=this.lineWidth,this._preCxt.strokeStyle=this.lineColor,this._preCxt.fillStyle=this.fillColor,this._preCxt.save(),this._preCxt.beginPath(),this._preCxt.translate(centerX-radX,centerY-radY),this._preCxt.scale(radX,radY),this._preCxt.arc(1,1,1,0,2*Math.PI,!1),this._preCxt.restore(),this._preCxt.stroke(),localStorage.antiAlias||this._deAntiAlias(),this._preCxt.globalCompositeOperation="destination-over",this._preCxt.fill(),this._preCxt.globalCompositeOperation="source-over","fillOnly"!==localStorage.outlineOption||localStorage.antiAlias||this._deAntiAlias()},EraserTool.prototype=Object.create(DrawingTool.prototype),EraserTool.prototype.activate=function(){DrawingTool.prototype.activate.apply(this),this._preCxt.canvas.style.cursor=EraserTool.getCursorCSS()},EraserTool.prototype.start=function(pointerState){DrawingTool.prototype.start.apply(this,arguments),this._lastX=pointerState.x,this._lastY=pointerState.y;var cxt=localStorage.ghostDraw?this._preCxt:this._cxt;cxt.fillStyle=this._fillColor,cxt.fillRect(pointerState.x-this._lineWidth/2,pointerState.y-this._lineWidth/2,this._lineWidth,this._lineWidth)},EraserTool.prototype.move=function(pointerState){DrawingTool.prototype.move.apply(this,arguments);var cxt=localStorage.ghostDraw?this._preCxt:this._cxt;cxt.fillStyle=this._fillColor,cxt.beginPath(),cxt.moveTo(pointerState.x-this._lineWidth/2,pointerState.y-this._lineWidth/2),cxt.lineTo(this._lastX-this._lineWidth/2,this._lastY-this._lineWidth/2),cxt.lineTo(this._lastX,this._lastY),cxt.lineTo(pointerState.x,pointerState.y),cxt.moveTo(pointerState.x+this._lineWidth/2,pointerState.y-this._lineWidth/2),cxt.lineTo(this._lastX+this._lineWidth/2,this._lastY-this._lineWidth/2),cxt.lineTo(this._lastX,this._lastY),cxt.lineTo(pointerState.x,pointerState.y),cxt.moveTo(pointerState.x+this._lineWidth/2,pointerState.y+this._lineWidth/2),cxt.lineTo(this._lastX+this._lineWidth/2,this._lastY+this._lineWidth/2),cxt.lineTo(this._lastX,this._lastY),cxt.lineTo(pointerState.x,pointerState.y),cxt.moveTo(pointerState.x-this._lineWidth/2,pointerState.y+this._lineWidth/2),cxt.lineTo(this._lastX-this._lineWidth/2,this._lastY+this._lineWidth/2),cxt.lineTo(this._lastX,this._lastY),cxt.lineTo(pointerState.x,pointerState.y),cxt.closePath(),cxt.fill(),cxt.fillStyle=this._fillColor,cxt.fillRect(pointerState.x-this._lineWidth/2,pointerState.y-this._lineWidth/2,this._lineWidth,this._lineWidth),this._lastX=pointerState.x,this._lastY=pointerState.y},EraserTool.getCursorCSS=function(){var size=parseInt(localStorage.lineWidth)*zoomManager.level+2;if(cursorCanvas.width=cursorCanvas.height=Math.min(128,size),size>128)return"crosshair";cursorCxt.lineWidth=1,cursorCxt.strokeStyle="black",cursorCxt.fillStyle=localStorage.fillColor,cursorCxt.fillRect(0,0,cursorCanvas.width,cursorCanvas.height),cursorCxt.strokeRect(0,0,cursorCanvas.width,cursorCanvas.height);var cursorDataURL=cursorCanvas.toDataURL(),cursorCSS="url("+cursorDataURL+")";
return cursorCSS+=" "+cursorCanvas.width/2+" "+cursorCanvas.height/2,cursorCSS+=", default"},FloodFillTool.prototype=Object.create(Tool.prototype),FloodFillTool.prototype._fill=function(startX,startY){if(!this._filling){this._filling=!0,this._imageData=this._cxt.getImageData(0,0,this._cxt.canvas.width,this._cxt.canvas.height);var pixelPos=4*(startY*this._imageData.width+startX),pixelStack=[[startX,startY]];if(this._startColor={r:this._imageData.data[pixelPos],g:this._imageData.data[pixelPos+1],b:this._imageData.data[pixelPos+2]},this._fillColor.r===this._startColor.r&&this._fillColor.g===this._startColor.g&&this._fillColor.b===this._startColor.b)return void(this._filling=!1);for(;pixelStack.length>0;){var pos=pixelStack.pop(),x=pos[0],y=pos[1];for(pixelPos=4*(y*this._imageData.width+x);y-- >=0&&this._checkColorMatch(pixelPos);)pixelPos-=4*this._imageData.width;pixelPos+=4*this._imageData.width,y++;for(var rightPixel=!1,leftPixel=!1;y++<this._imageData.height-1&&this._checkColorMatch(pixelPos);)this._colorPixel(pixelPos),x>0&&(this._checkColorMatch(pixelPos-4)?leftPixel||(pixelStack.push([x-1,y]),leftPixel=!0):leftPixel=!1),x<this._imageData.width-1&&(this._checkColorMatch(pixelPos+4)?rightPixel||(pixelStack.push([x+1,y]),rightPixel=!0):rightPixel=!1),pixelPos+=4*canvas.width}this._cxt.putImageData(this._imageData,0,0),this._filling=!1}},FloodFillTool.prototype._checkColorMatch=function(pixelPos){var r=this._imageData.data[pixelPos],g=this._imageData.data[pixelPos+1],b=this._imageData.data[pixelPos+2];return r===this._startColor.r&&g===this._startColor.g&&b===this._startColor.b},FloodFillTool.prototype._colorPixel=function(pixelPos){this._imageData.data[pixelPos]=this._fillColor.r,this._imageData.data[pixelPos+1]=this._fillColor.g,this._imageData.data[pixelPos+2]=this._fillColor.b},FloodFillTool.prototype.activate=function(){this._filling=!1,this._imageData=[],this._startColor={},this._preCxt.canvas.style.cursor="url(images/cursors/paint_bucket.cur), default"},FloodFillTool.prototype.start=function(pointerState){2!==pointerState.button?this._fillColor=Utils.colorToRGB(localStorage.lineColor):this._fillColor=Utils.colorToRGB(localStorage.fillColor),this._fill(Math.floor(pointerState.x),Math.floor(pointerState.y)),undoStack.addState()},EyedropperTool.prototype=Object.create(Tool.prototype),EyedropperTool.prototype.activate=function(){this._preCxt.canvas.style.cursor="url(images/cursors/eyedropper.cur), default"},EyedropperTool.prototype.start=function(pointerState){this._button=pointerState.button,this.move(pointerState)},EyedropperTool.prototype.move=function(pointerState){this._imageData=this._cxt.getImageData(0,0,this._cxt.canvas.width,this._cxt.canvas.height);var pixelPos=4*(Math.floor(pointerState.y)*this._imageData.width+Math.floor(pointerState.x)),color=ColorPicker.rgb2hex({r:this._imageData.data[pixelPos],g:this._imageData.data[pixelPos+1],b:this._imageData.data[pixelPos+2]});0===this._button?(localStorage.lineColor=color,document.getElementById("colors").style.borderColor=color):2===this._button&&(localStorage.fillColor=color,document.getElementById("colors").style.backgroundColor=color)},SelectionTool.prototype=Object.create(Tool.prototype),SelectionTool.prototype.activate=function(){this._preCxt.canvas.style.cursor="crosshair"},SelectionTool.prototype.start=function(pointerState){pointerState.x=Math.round(pointerState.x),pointerState.y=Math.round(pointerState.y),this._selection&&Utils.isPointInRect(pointerState.x,pointerState.y,this._selection.x,this._selection.y,this._selection.width,this._selection.height)?(this._selection.pointerOffset={x:pointerState.x-this._selection.x,y:pointerState.y-this._selection.y},this._preCxt.canvas.style.cursor="move"):(this._saveSelection(),this._selection={startX:pointerState.x,startY:pointerState.y,x:pointerState.x,y:pointerState.y,width:0,height:0},this._updateSelectionOutline(),document.body.appendChild(this._outline))},SelectionTool.prototype.move=function(pointerState){this._selection&&(pointerState.x=Math.round(pointerState.x),pointerState.y=Math.round(pointerState.y),Utils.clearCanvas(this._preCxt),this._selection.pointerOffset?(this._selection.x=pointerState.x-this._selection.pointerOffset.x,this._selection.y=pointerState.y-this._selection.pointerOffset.y,this._drawSelectionContent(),this._updateSelectionOutline()):(pointerState.x=Math.max(0,Math.min(this._cxt.canvas.width,pointerState.x)),pointerState.y=Math.max(0,Math.min(this._cxt.canvas.height,pointerState.y)),this._selection.width=pointerState.x-this._selection.startX,this._selection.height=pointerState.y-this._selection.startY,this._selection.width<0&&(this._selection.x=this._selection.startX+this._selection.width,this._selection.width=Math.abs(this._selection.width)),this._selection.height<0&&(this._selection.y=this._selection.startY+this._selection.height,this._selection.height=Math.abs(this._selection.height)),this._updateSelectionOutline()))},SelectionTool.prototype.end=function(pointerState){if(pointerState.x=Math.round(pointerState.x),pointerState.y=Math.round(pointerState.y),this.move(pointerState),this._preCxt.canvas.style.cursor="crosshair",!this._selection.pointerOffset){if(0===this._selection.width||0===this._selection.height)return delete this._selection,Utils.clearCanvas(this._preCxt),void document.body.removeChild(this._outline);this._selection.startX=this._selection.x,this._selection.startY=this._selection.y,this._selection.content=this._cxt.getImageData(this._selection.startX,this._selection.startY,this._selection.width,this._selection.height)}},SelectionTool.prototype.deactivate=function(){this._saveSelection(),document.body.contains(this._outline)&&document.body.removeChild(this._outline),delete this._selection},SelectionTool.prototype.clear=function(){this._selection&&(this._cxt.fillStyle=localStorage.fillColor,this._cxt.fillRect(this._selection.startX,this._selection.startY,this._selection.width,this._selection.height),Utils.clearCanvas(this._preCxt),document.body.removeChild(this._outline),undoStack.addState(),delete this._selection)},SelectionTool.prototype.duplicate=function(){this._selection&&(this._saveSelection(),this._selection.startX=this._preCxt.canvas.width+10,this._selection.startY=this._preCxt.canvas.height+10,this._selection.x=0,this._selection.y=0,this._drawSelectionContent(),this._drawSelectionOutline())},SelectionTool.prototype.selectAll=function(width,height){this.start({x:0,y:0}),this.move({x:width,y:height}),this.end({x:width,y:height})},SelectionTool.prototype._updateSelectionOutline=function(){if(this._selection){var zoomedX=Math.floor(zoomManager.level*this._selection.x),zoomedY=Math.floor(zoomManager.level*this._selection.y),zoomedWidth=Math.ceil(zoomManager.level*this._selection.width),zoomedHeight=Math.ceil(zoomManager.level*this._selection.height);this._outline.style.WebkitTransform=this._outline.style.MozTransform=this._outline.style.MsTransform=this._outline.style.OTransform=this._outline.style.transform="translate("+zoomedX+"px, "+zoomedY+"px)",this._outline.style.width=zoomedWidth+"px",this._outline.style.height=zoomedHeight+"px"}},SelectionTool.prototype._drawSelectionContent=function(){this._selection&&this._selection.content&&(this._preCxt.fillStyle=localStorage.fillColor,this._preCxt.fillRect(this._selection.startX,this._selection.startY,this._selection.width,this._selection.height),this._preCxt.putImageData(this._selection.content,this._selection.x,this._selection.y))},SelectionTool.prototype._saveSelection=function(){Utils.clearCanvas(this._preCxt),!this._selection||this._selection.x===this._selection.startX&&this._selection.y===this._selection.startY||(this._drawSelectionContent(),this._cxt.drawImage(this._preCxt.canvas,0,0),Utils.clearCanvas(this._preCxt),undoStack.addState())},TextTool.GRABBABLE_MARGIN=4,TextTool.MIN_SIZE=7,TextTool.PADDING=4,TextTool.BORDER_WIDTH=1,TextTool.LINE_HEIGHT=1,TextTool.prototype=Object.create(Tool.prototype),TextTool.prototype.activate=function(){this._preCxt.canvas.style.cursor="crosshair",this._textElem.style.color=localStorage.lineColor,this._textElem.style.font=localStorage.fontSize+"px sans-serif",this._textElem.style.WebkitTransform=this._textElem.style.MozTransform=this._textElem.style.MsTransform=this._textElem.style.OTransform=this._textElem.style.transform="scale("+zoomManager.level+")"},TextTool.prototype.start=function(pointerState){pointerState.x=Math.round(pointerState.x),pointerState.y=Math.round(pointerState.y),this._textRegion&&Utils.isPointInRect(pointerState.x,pointerState.y,this._textRegion.x-TextTool.GRABBABLE_MARGIN,this._textRegion.y-TextTool.GRABBABLE_MARGIN,this._textRegion.width+2*TextTool.GRABBABLE_MARGIN,this._textRegion.height+2*TextTool.GRABBABLE_MARGIN)?(this._textRegion.pointerOffset={x:pointerState.x-this._textRegion.x,y:pointerState.y-this._textRegion.y},this._preCxt.canvas.style.cursor=this._textElem.style.cursor="move"):(this._saveText(),this._textRegion={startX:pointerState.x,startY:pointerState.y,x:pointerState.x,y:pointerState.y,width:0,height:0},this._textElem.innerHTML="",this._updateTextElem(),document.body.contains(this._textElem)||document.body.appendChild(this._textElem)),this._textElem.style.pointerEvents=null,this._pasting=!1;var that=this;this._textElem.addEventListener("paste",function(e){if(!that._pasting)if(e.originalEvent&&e.originalEvent.clipboardData&&e.originalEvent.clipboardData.getData){that._pasting=!0,e.preventDefault();var pastedText=e.originalEvent.clipboardData.getData("text/plain");document.execCommand("insertText",!1,pastedText)}else if(e.clipboardData&&e.clipboardData.getData){that._pasting=!0,e.preventDefault();var pastedText=e.clipboardData.getData("text/plain");document.execCommand("insertText",!1,pastedText)}else window.clipboardData&&window.clipboardData.getData&&(that._pasting=!0,e.preventDefault(),window.document.execCommand("ms-pasteTextOnly",!1));that.pasting=!1},!1),keyManager.disableAppShortcuts()},TextTool.prototype.move=function(pointerState){this._textRegion&&(pointerState.x=Math.round(pointerState.x),pointerState.y=Math.round(pointerState.y),Utils.clearCanvas(this._preCxt),this._textRegion.pointerOffset?(this._textRegion.x=pointerState.x-this._textRegion.pointerOffset.x,this._textRegion.y=pointerState.y-this._textRegion.pointerOffset.y,this._updateTextElem()):(pointerState.x=Math.max(0,Math.min(this._cxt.canvas.width,pointerState.x)),pointerState.y=Math.max(0,Math.min(this._cxt.canvas.height,pointerState.y)),this._textRegion.width=pointerState.x-this._textRegion.startX,this._textRegion.height=pointerState.y-this._textRegion.startY,this._textRegion.width<0&&(this._textRegion.x=this._textRegion.startX+this._textRegion.width,this._textRegion.width=Math.abs(this._textRegion.width)),this._textRegion.height<0&&(this._textRegion.y=this._textRegion.startY+this._textRegion.height,this._textRegion.height=Math.abs(this._textRegion.height)),this._updateTextElem()))},TextTool.prototype.end=function(pointerState){if(pointerState.x=Math.round(pointerState.x),pointerState.y=Math.round(pointerState.y),this.move(pointerState),this._textElem.style.pointerEvents="auto",this._textElem.style.cursor=null,this._preCxt.canvas.style.cursor="crosshair",this._textRegion&&!this._textRegion.pointerOffset){if(this._textRegion.width<TextTool.MIN_SIZE||this._textRegion.height<TextTool.MIN_SIZE)return void this._removeTextElem();this._textRegion.startX=this._textRegion.x,this._textRegion.startY=this._textRegion.y,this._textElem.focus()}},TextTool.prototype.deactivate=function(){this._removeTextElem()},TextTool.prototype._updateTextElem=function(){if(this._textRegion){var zoomedX=Math.floor(zoomManager.level*this._textRegion.x),zoomedY=Math.floor(zoomManager.level*this._textRegion.y);Math.ceil(zoomManager.level*this._textRegion.width),Math.ceil(zoomManager.level*this._textRegion.height);this._textElem.style.WebkitTransform=this._textElem.style.MozTransform=this._textElem.style.MsTransform=this._textElem.style.OTransform=this._textElem.style.transform="translate("+zoomedX+"px, "+zoomedY+"px) scale("+zoomManager.level+")",this._textElem.style.width=this._textRegion.width+"px",this._textElem.style.height=this._textRegion.height+"px"}},TextTool.prototype._removeTextElem=function(){if(this._saveText(),delete this._textRegion,document.body.contains(this._textElem))try{document.body.removeChild(this._textElem)}catch(ex){}keyManager.enableAppShortcuts()},TextTool.prototype._saveText=function(){if(this._textRegion&&""!==this._textElem.innerHTML){for(var words=(this._textElem.innerText||this.textElem.textContent).replace(/\n/g," \n ").split(" "),line="",lines=[],maxWidth=this._textRegion.width-2*TextTool.PADDING-2*TextTool.BORDER_WIDTH,i=0;i<words.length;i++)("\n"===words[i]||Math.ceil(cxt.measureText(line+words[i]).width)>maxWidth)&&(lines.push(line),line=""),"\n"!==words[i]&&(line+=words[i]+" ");lines.push(line),this._cxt.textBaseline="top",this._cxt.fillStyle=localStorage.lineColor,this._cxt.font=localStorage.fontSize+"px sans-serif";for(var i=0;i<lines.length;i++){var x=this._textRegion.x+TextTool.PADDING+TextTool.BORDER_WIDTH,y=this._textRegion.y+TextTool.PADDING+TextTool.BORDER_WIDTH+(parseInt(localStorage.fontSize)+2)*i;this._cxt.fillText(lines[i],x,y)}Utils.clearCanvas(this._preCxt),undoStack.addState()}},PanTool.prototype=Object.create(Tool.prototype),PanTool.prototype.activate=function(){this._preCxt.canvas.style.cursor="move",this._preCxt.canvas.style.cursor="-webkit-grab",this._preCxt.canvas.style.cursor="-moz-grab",this._preCxt.canvas.style.cursor="grab"},PanTool.prototype.start=function(pointerState){0===pointerState.button&&(this._startX=pointerState.x,this._startY=pointerState.y,this._preCxt.canvas.style.cursor="-webkit-grabbing",this._preCxt.canvas.style.cursor="-moz-grabbing",this._preCxt.canvas.style.cursor="grabbing")},PanTool.prototype.move=function(pointerState){var scrollX=document.body.scrollLeft+(this._startX-pointerState.x),scrollY=document.body.scrollTop+(this._startY-pointerState.y);window.scrollTo(scrollX,scrollY)},PanTool.prototype.end=function(pointerState){this.move(pointerState),this._preCxt.canvas.style.cursor="-webkit-grab",this._preCxt.canvas.style.cursor="-moz-grab",this._preCxt.canvas.style.cursor="grab"},PacMan.RADIUS=30,PacMan.HITBOX_PADDING=3,PacMan.SPEED=2,PacMan.MOUTH_SPEED=Math.PI/16,PacMan.MAX_MOUTH_SIZE=Math.PI/4,PacMan.START_SOUND_LENGTH=4e3,PacMan.HEADINGS={RIGHT:0,DOWN:.5*Math.PI,LEFT:Math.PI,UP:1.5*Math.PI},PacMan.KEYS={LEFT:[37,65],UP:[38,44,87],RIGHT:[39,68,69],DOWN:[40,79,83]},PacMan.prototype.start=function(){this._started||(this._draw(),this._startSound&&this._startSound.play&&(this._startSound.currentTime=0,this._startSound.play()),this._started=!0,setTimeout(this._boundUpdate,PacMan.START_SOUND_LENGTH))},PacMan.prototype.stop=function(){this._erase(),this._startSound.pause(),this._started=!1},PacMan.prototype._isBlocked=function(){this._cxt.fillStyle=localStorage.lineColor,this._cxt.fillRect(this.x-1,this.y-1,3,3);var imageData=this._cxt.getImageData(this.x-(PacMan.RADIUS+PacMan.HITBOX_PADDING+1),this.y-(PacMan.RADIUS+PacMan.HITBOX_PADDING+1),2*(PacMan.RADIUS+PacMan.HITBOX_PADDING+1),2*(PacMan.RADIUS+PacMan.HITBOX_PADDING+1)),wallColor={r:imageData.data[imageData.height/2*imageData.width*4+imageData.width/2*4],g:imageData.data[imageData.height/2*imageData.width*4+imageData.width/2*4+1],b:imageData.data[imageData.height/2*imageData.width*4+imageData.width/2*4+2]};this._cxt.fillStyle=localStorage.fillColor,this._cxt.fillRect(this.x-1,this.y-1,3,3);for(var i=Math.PI/8;i<7*Math.PI/8;i+=1/60){var x=Math.round((PacMan.RADIUS+PacMan.HITBOX_PADDING)*Math.sin(i+this.heading)),y=-Math.round((PacMan.RADIUS+PacMan.HITBOX_PADDING)*Math.cos(i+this.heading)),col=x+imageData.width/2,row=y+imageData.height/2,color={r:imageData.data[row*imageData.width*4+4*col],g:imageData.data[row*imageData.width*4+4*col+1],b:imageData.data[row*imageData.width*4+4*col+2],a:imageData.data[row*imageData.width*4+4*col+3]};if(color.r===wallColor.r&&color.g===wallColor.g&&color.b===wallColor.b&&255===color.a)return!0}return!1},PacMan.prototype._draw=function(){this._cxt.fillStyle="yellow",this._cxt.beginPath(),this._cxt.arc(this.x,this.y,PacMan.RADIUS-1,.5*Math.PI+this.heading,1.5*Math.PI+this.heading,!1),this._cxt.closePath(),this._cxt.fill(),this._cxt.beginPath(),this._cxt.moveTo(this.x,this.y),this._cxt.arc(this.x,this.y,PacMan.RADIUS-1,this._mouthSize+this.heading,.5*Math.PI+this.heading,!1),this._cxt.closePath(),this._cxt.fill(),this._cxt.beginPath(),this._cxt.moveTo(this.x,this.y),this._cxt.arc(this.x,this.y,PacMan.RADIUS-1,1.5*Math.PI+this.heading,2*Math.PI-this._mouthSize+this.heading,!1),this._cxt.closePath(),this._cxt.fill()},PacMan.prototype._erase=function(){this._cxt.fillStyle=localStorage.fillColor,this._cxt.beginPath(),this._cxt.arc(this.x,this.y,PacMan.RADIUS,.5*Math.PI+this.heading,1.5*Math.PI+this.heading,!1),this._cxt.closePath(),this._cxt.fill(),this._cxt.beginPath(),this._cxt.moveTo(this.x,this.y),this._cxt.arc(this.x,this.y,PacMan.RADIUS,this._mouthSize+this.heading,.5*Math.PI+this.heading,!1),this._cxt.closePath(),this._cxt.fill(),this._cxt.beginPath(),this._cxt.moveTo(this.x,this.y),this._cxt.arc(this.x,this.y,PacMan.RADIUS,1.5*Math.PI+this.heading,2*Math.PI-this._mouthSize+this.heading,!1),this._cxt.closePath(),this._cxt.fill()},PacMan.prototype._initListeners=function(){window.addEventListener("keydown",function(e){PacMan.KEYS.UP.indexOf(e.keyCode)!==-1?(e.preventDefault(),this.heading=PacMan.HEADINGS.UP):PacMan.KEYS.RIGHT.indexOf(e.keyCode)!==-1?(e.preventDefault(),this.heading=PacMan.HEADINGS.RIGHT):PacMan.KEYS.DOWN.indexOf(e.keyCode)!==-1?(e.preventDefault(),this.heading=PacMan.HEADINGS.DOWN):PacMan.KEYS.LEFT.indexOf(e.keyCode)!==-1&&(e.preventDefault(),this.heading=PacMan.HEADINGS.LEFT)}.bind(this),!1)},PacMan.prototype._update=function(){if(this._started){if(Utils.raf(this._boundUpdate),this._erase(),!this._isBlocked())switch(this.heading){case PacMan.HEADINGS.UP:this.y-=PacMan.SPEED;break;case PacMan.HEADINGS.RIGHT:this.x+=PacMan.SPEED;break;case PacMan.HEADINGS.DOWN:this.y+=PacMan.SPEED;break;case PacMan.HEADINGS.LEFT:this.x-=PacMan.SPEED}this._mouthSize+=PacMan.MOUTH_SPEED*(this._mouthOpening?1:-1),this._mouthOpening&&this._mouthSize>PacMan.MAX_MOUTH_SIZE?(this._mouthSize=PacMan.MAX_MOUTH_SIZE,this._mouthOpening=!1):!this._mouthOpening&&this._mouthSize<0&&(this._mouthSize=0,this._mouthOpening=!0),this.x<-(2*PacMan.RADIUS)?this.x=canvas.width+2*PacMan.RADIUS:this.x>canvas.width+2*PacMan.RADIUS?this.x=-(2*PacMan.RADIUS):this.y<-(2*PacMan.RADIUS)?this.y=canvas.height+2*PacMan.RADIUS:this.y>canvas.height+2*PacMan.RADIUS&&(this.y=-(2*PacMan.RADIUS)),this._draw()}};var PNG_REGEX=/.+\.png$/i,JPEG_REGEX=/.+\.(jpg|jpeg|jpe|jif|jfif|jfi)$/i,FILE_EXT_REGEX=/\.[a-z0-9]{1,4}$/i,DEFAULTS={width:640,height:480,lineWidth:2,outlineOption:"outlineFill",lineColor:"#000000",fillColor:"#ffffff",fontSize:16,tool:"doodle",ghostDraw:"",antiAlias:!0,maxUndoStackDepth:50},canvas,preCanvas,cursorCanvas,cxt,preCxt,cursorCxt,downloadLink,tools,progressSpinner;window.addEventListener("load",function(){Utils.isApple&&(document.body.innerHTML=document.body.innerHTML.replace(/Ctrl\+/g,"&#x2318;").replace(/Alt\+/g,"&#x2325;").replace(/Shift\+/g,"&#x21e7;")),Utils.makeDialog(document.getElementById("keyboardDialog")),downloadLink=document.getElementById("downloadLink"),initToolbar(),initCanvas(),initSettings(),initTools(),zoomManager.init(),resetCanvas(),undoStack.addState(),keyManager.enableAppShortcuts(),progressSpinner=document.getElementById("progressSpinner"),Utils.makeDialog(progressSpinner),localStorage.firstRunDone||(document.getElementById("welcomeDialog").open(),localStorage.firstRunDone="true")},!1);